name: Notify Discord

on:
  push:
    paths:
      - 'Summer2025-Internships/.github/scripts/listings.json' # Only run when listings.json is edited
      - 'discord-job-listings-bot/.github/workflows/nsbe-discord-opportunities-bot.yml' # Only run when the nsbe-discord-opportunities-bot.yml is edited
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout job listings repository
        uses: actions/checkout@v2
        with:
          repository: SimplifyJobs/Summer2025-Internships # Public repository with job listings
          path: job-listings

      - name: Checkout bot repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jq requests

      - name: Extract and Send job listings
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cat << 'EOF' > script.py
          import json
          import os
          from datetime import datetime
          from pathlib import Path
          import requests

          # Load the listings
          listings_path = Path('Summer2025-Internships/.github/scripts/listings.json')
          with listings_path.open() as f:
              listings = json.load(f)

          # Get the most recent listing (the last one in the JSON file)
          recent_listing = listings[-1]

          # Extract the ID of the most recent listing
          recent_listing_id = recent_listing['id']

          # Load the last sent listing ID from last_listing.json
          last_listing_path = Path('discord-job-listings-bot/.github/workflows/last_listing.json')
          if last_listing_path.exists():
              with last_listing_path.open() as f:
                  last_sent_listing = json.load(f)
                  last_sent_listing_id = last_sent_listing[0]['id']
          else:
              last_sent_listing_id = None

          # Print the last sent listing ID and recent listing ID
          print(f"Last Sent Listing ID: {last_sent_listing_id}")
          print(f"Recent Listing ID: {recent_listing_id}")

          if recent_listing_id == last_sent_listing_id:
              print("No new listings to send. IDs matched.")
              note_message = "No new job listings to send at this time."
              response = requests.post(
                  os.getenv('DISCORD_WEBHOOK'),
                  json={'content': note_message}
              )
              response.raise_for_status()
          else:
              # Extract listing details
              company_name = recent_listing['company_name']
              title = recent_listing['title']
              locations = ', '.join(recent_listing['locations'])
              url = recent_listing['url']
              date_posted = datetime.fromtimestamp(recent_listing['date_posted']).strftime('%Y-%m-%d')
              term = ', '.join(recent_listing['terms'])

              # Format the message
              message = (
                  f"**Company:** {company_name}\n"
                  f"**Role:** {title}\n"
                  f"**Location:** {locations}\n"
                  f"**Application/Link:** [Apply Here]({url})\n"
                  f"**Date Posted:** {date_posted}\n"
                  f"**Term:** {term}\n"
                  "---------------------------"
              )

              # Send the message to Discord
              response = requests.post(
                  os.getenv('DISCORD_WEBHOOK'),
                  json={'content': message}
              )
              response.raise_for_status()

              # Output the sent message
              print("\n--- Sent Listing ---")
              print(message)

              # Update the last sent listing ID in last_listing.json
              with last_listing_path.open('w') as f:
                  json.dump([recent_listing], f)

              # Commit message for the listings
              commit_message = f"Updated last listing sent to Discord: {title}"
              print(f"\n--- Commit Message ---\n{commit_message}")

          EOF
          python script.py

      - name: Commit and push updated last listing
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add .github/workflows/last_listing.json
          git commit -m "Update last sent listing"
          git push
